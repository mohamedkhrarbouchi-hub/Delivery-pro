<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Delivery Intelligence OS â€“ ONLINE</title>

<!-- Manifest PWA -->
<link rel="manifest" href="data:application/json,{
  &quot;name&quot;:&quot;Delivery OS&quot;,
  &quot;short_name&quot;:&quot;DeliveryOS&quot;,
  &quot;start_url&quot;:&quot;.&quot;,
  &quot;display&quot;:&quot;standalone&quot;,
  &quot;background_color&quot;:&quot;#0f172a&quot;,
  &quot;theme_color&quot;:&quot;#2563eb&quot;
}">

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{font-family:system-ui;background:#0f172a;color:#f1f5f9;padding:15px}
.card{background:#1e293b;padding:15px;border-radius:14px;margin-bottom:15px}
input,select,button{width:100%;padding:12px;border-radius:10px;border:0;margin-top:8px}
button{font-weight:bold;background:#2563eb;color:white}
.small{font-size:.85rem;opacity:.8}
</style>
</head>

<body>

<h3>ğŸš€ Delivery Intelligence OS</h3>

<div class="card">
<b>ğŸ“¦ Ø·Ù„Ø¨ÙŠØ©</b>
<input id="amt" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
<select id="pay">
<option value="cash">ÙƒØ§Ø´</option>
<option value="app">ØªØ·Ø¨ÙŠÙ‚</option>
</select>
<input id="note" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©">
<button onclick="addOrder()">ØªØ³Ø¬ÙŠÙ„</button>
</div>

<div class="card">
<b>â›½ Ù…ØµØ±ÙˆÙ</b>
<input id="eAmt" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
<input id="eNote" placeholder="Ø§Ù„ÙˆØµÙ">
<button style="background:#dc2626" onclick="addExpense()">ØªØ³Ø¬ÙŠÙ„</button>
</div>

<div class="card">
<b>ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ©</b>
<p id="km">0 KM</p>
<p class="small">ğŸ’° Ø±Ø¨Ø­ Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±: <span id="kmProfit">0</span></p>
<button onclick="startTrack()">Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹</button>
<button onclick="stopTrack()">Ø¥ÙŠÙ‚Ø§Ù</button>
</div>

<div class="card">
<b>ğŸ”” ØªØ°ÙƒÙŠØ±</b>
<input id="remTxt" placeholder="Ø§Ù„Ù†Øµ">
<input id="remMin" type="number" placeholder="Ø¨Ø¹Ø¯ ÙƒÙ… Ø¯Ù‚ÙŠÙ‚Ø©">
<button onclick="setReminder()">Ø¶Ø¨Ø·</button>
</div>

<div class="card">
<b>ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬</b>
<p>ğŸ’° Ø§Ù„ØµØ§ÙÙŠ: <span id="net">0</span></p>
<p>ğŸ‘ Ø§Ù„ÙƒØ§Ø´: <span id="cash">0</span></p>
</div>

<div class="card">
<b>ğŸ“œ Ø§Ù„Ø³Ø¬Ù„</b>
<div id="log"></div>
</div>

<button onclick="exportExcel()">ğŸ“¥ Excel</button>

<script>
/* ================== STATE ================== */
const DB="delivery_online";
let state=JSON.parse(localStorage.getItem(DB))||{
orders:[],expenses:[],km:0,reminders:[]
};

/* ================== SAVE ================== */
const save=()=>localStorage.setItem(DB,JSON.stringify(state));

/* ================== ORDERS ================== */
function addOrder(){
let a=+amt.value;if(a<=0)return;
state.orders.push({a,p:pay.value,n:note.value,t:Date.now()});
save();calc();
}

/* ================== EXPENSE ================== */
function addExpense(){
let a=+eAmt.value;if(a<=0)return;
state.expenses.push({a,n:eNote.value,t:Date.now()});
save();calc();
}

/* ================== CALC ================== */
function calc(){
let rev=0,cash=0,ex=0;
state.orders.forEach(o=>{rev+=o.a;if(o.p==="cash")cash+=o.a});
state.expenses.forEach(e=>ex+=e.a);
net.textContent=(rev*0.5-ex).toFixed(2);
cash.textContent=(cash-ex).toFixed(2);
kmProfit.textContent=(state.km>0?(net.textContent/state.km).toFixed(2):0);
render();
}

/* ================== LOG ================== */
function render(){
log.innerHTML="";
[...state.orders,...state.expenses]
.sort((a,b)=>b.t-a.t).slice(0,10)
.forEach(i=>{
log.innerHTML+=`<div class="small">${i.a} â€” ${i.n||''}</div>`;
});
}

/* ================== DISTANCE ================== */
let watchId,lastPos;
function startTrack(){
navigator.geolocation.getCurrentPosition(p=>lastPos=p.coords);
watchId=navigator.geolocation.watchPosition(p=>{
if(lastPos){
let d=distance(lastPos.latitude,lastPos.longitude,p.coords.latitude,p.coords.longitude);
state.km+=d;
km.textContent=state.km.toFixed(2)+" KM";
save();
}
lastPos=p.coords;
});
}
function stopTrack(){navigator.geolocation.clearWatch(watchId)}
function distance(lat1,lon1,lat2,lon2){
const R=6371;
let dLat=(lat2-lat1)*Math.PI/180;
let dLon=(lon2-lon1)*Math.PI/180;
let a=Math.sin(dLat/2)**2+
Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* ================== REMINDER ================== */
function setReminder(){
let t=remTxt.value,m=+remMin.value;
if(!t||m<=0)return;
state.reminders.push({t,at:Date.now()+m*60000});
save();
alert("ØªÙ… Ø¶Ø¨Ø· Ø§Ù„ØªØ°ÙƒÙŠØ±");
}
setInterval(()=>{
state.reminders=state.reminders.filter(r=>{
if(Date.now()>=r.at){
notify("ğŸ”” ØªØ°ÙƒÙŠØ±",r.t);
return false;
}
return true;
});
save();
},10000);

/* ================== NOTIFICATION ================== */
function notify(title,body){
if(Notification.permission==="granted")
new Notification(title,{body});
}

/* ================== EXCEL ================== */
function exportExcel(){
let wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(state.orders),"Orders");
XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(state.expenses),"Expenses");
XLSX.writeFile(wb,"Delivery_Report.xlsx");
}

/* ================== PWA + SW ================== */
if('serviceWorker'in navigator){
const sw=`
self.addEventListener('install',e=>self.skipWaiting());
self.addEventListener('fetch',e=>{});
`;
navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw])));
}
if(Notification.permission!=="granted")Notification.requestPermission();

calc();
</script>

</body>
</html></head>
<body class="dark" id="bodyTag">

<audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

<div class="top-bar">
    <button class="btn" style="background:var(--w); font-size:12px;" onclick="initAudio()">ğŸ”Š ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª</button>
    <button class="btn" id="themeBtn" style="background:#475569" onclick="toggleTheme()">ğŸŒ“ Ù„ÙŠÙ„/Ù†Ù‡Ø§Ø±</button>
</div>

<div class="stats-grid">
    <div class="stat-box" style="border-color:var(--s)">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ <span id="net">0</span></div>
    <div class="stat-box" style="border-color:var(--w)">Ø§Ù„ÙƒØ§Ø´ Ø¨ÙŠØ¯Ùƒ <span id="cash">0</span></div>
    <div class="stat-box">Ø­Ù‚ Ø§Ù„Ø±Ø¦ÙŠØ³ <span id="boss">0</span></div>
    <div class="stat-box" style="border-color:#6366f1">Ø§Ù„ØµÙŠØ§Ù†Ø© <span id="mFund">0</span></div>
</div>

<hr style="opacity:0.1; margin:15px 0">

<div id="sec-orders">
    <div class="card">
        <b>ğŸ“¦ ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨ÙŠØ©</b>
        <div class="flex-row">
            <input id="oAmt" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" inputmode="decimal">
            <select id="oPay">
                <option value="cash">ğŸ’µ ÙƒØ§Ø´</option>
                <option value="app">ğŸ’³ ØªØ·Ø¨ÙŠÙ‚</option>
            </select>
        </div>
        <div class="flex-row">
            <input id="oName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†/Ø§Ù„Ù…Ø­Ù„">
            <input id="oPhone" type="tel" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨)">
        </div>
        <div class="flex-row">
            <button class="btn" style="width:100%" onclick="add('order')">ØªØ³Ø¬ÙŠÙ„ ÙˆØ­ÙØ¸ âœ…</button>
        </div>
    </div>
</div>

<div id="sec-expenses" class="hidden">
    <div class="card">
        <b>â›½ ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ</b>
        <div class="flex-row">
            <input id="eAmt" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" inputmode="decimal">
            <input id="eNote" placeholder="Ø¨Ù†Ø²ÙŠÙ†ØŒ Ø¥ØµÙ„Ø§Ø­...">
            <button class="btn" style="background:var(--d)" onclick="add('expense')">Ø­ÙØ¸</button>
        </div>
    </div>
</div>

<div id="sec-more" class="hidden">
    <div class="card">
        <b>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (%)</b>
        <div class="flex-row">
            <input id="rate" type="number" placeholder="Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚">
            <input id="maint" type="number" placeholder="Ù†Ø³Ø¨Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©">
            <button class="btn" onclick="saveSettings()">Ø­ÙØ¸</button>
        </div>
    </div>
    <button class="btn" style="width:100%; margin-bottom:10px" onclick="exportExcel()">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„</button>
    <button class="btn" style="width:100%; background:#475569" onclick="resetDay()">ğŸ”„ ØªØµÙÙŠØ± Ø§Ù„ÙŠÙˆÙ…</button>
</div>

<div class="card">
    <b>ğŸ“œ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø·ÙˆØ±</b>
    <div id="log"></div>
</div>

<div class="nav-bar">
    <div class="nav-item active" onclick="nav('orders', this)">ğŸ“¦<br>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
    <div class="nav-item" onclick="nav('expenses', this)">â›½<br>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
    <div class="nav-item" onclick="nav('more', this)">âš™ï¸<br>Ø§Ù„Ù…Ø²ÙŠØ¯</div>
</div>

<script>
const DB_KEY="delivery_pro_vFinal";
let state=JSON.parse(localStorage.getItem(DB_KEY))||{ settings:{rate:50,maint:5}, entries:[], reminders:[], theme:'dark' };

function toggleTheme(){
    state.theme = state.theme === 'dark' ? 'light' : 'dark';
    applyTheme(); save();
}
function applyTheme(){ document.getElementById('bodyTag').className = state.theme; }

// ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª
function initAudio() { 
    document.getElementById('notifSound').play().then(() => {
        alert("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ©");
    }).catch(() => alert("Ø§Ø¶ØºØ· ØªÙØ¹ÙŠÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"));
}

function nav(sec, el){
    ['orders','expenses','more'].forEach(s=> document.getElementById('sec-'+s).classList.add('hidden'));
    document.getElementById('sec-'+sec).classList.remove('hidden');
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    el.classList.add('active');
}

function save(){ localStorage.setItem(DB_KEY,JSON.stringify(state)); }

function add(type){
    let amt = type==='order' ? +oAmt.value : +eAmt.value;
    if(!amt || amt <=0) return;

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
    document.getElementById('notifSound').play();

    state.entries.push({
        id: Date.now(), 
        type, 
        amt,
        pay: type==='order' ? oPay.value : null,
        note: type==='order' ? (oName.value || 'Ø·Ù„Ø¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…') : (eNote.value || 'Ù…ØµØ±ÙˆÙ'),
        phone: type==='order' ? oPhone.value : '',
        time: new Date().toLocaleTimeString('ar-MA',{hour:'2-digit',minute:'2-digit'})
    });

    oAmt.value=oName.value=oPhone.value=eAmt.value=eNote.value='';
    save(); calc();
}

function calc(){
    let rev=0, cashCol=0, ex=0;
    state.entries.forEach(e=>{
        if(e.type==="order"){ rev += e.amt; if(e.pay==="cash") cashCol += e.amt; } 
        else ex += e.amt;
    });
    let myGross = rev * (state.settings.rate/100);
    let maintFee = myGross * (state.settings.maint/100);
    let myNet = myGross - ex - maintFee;
    let bossDue = (rev - myGross) - (rev - cashCol);

    document.getElementById('net').textContent = myNet.toFixed(2);
    document.getElementById('cash').textContent = (cashCol - ex).toFixed(2);
    document.getElementById('boss').textContent = bossDue.toFixed(2);
    document.getElementById('mFund').textContent = maintFee.toFixed(2);
    render();
}

function render(){
    const log = document.getElementById('log'); log.innerHTML="";
    state.entries.slice(-20).reverse().forEach(e=>{
        let waLink = e.phone ? `<a href="https://wa.me/${e.phone.replace(/\D/g,'')}" target="_blank" class="wa-btn">ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</a>` : '';
        log.innerHTML += `
            <div class="history-item">
                <div>
                    <b>${e.type==='order'?'ğŸ“¦':'â›½'} ${e.note}</b><br>
                    <small>${e.time} ${waLink}</small>
                </div>
                <span style="font-weight:bold; color:${e.type==='order'?'var(--s)':'var(--d)'}">${e.amt}</span>
            </div>`;
    });
}

function saveSettings(){
    state.settings.rate = +document.getElementById('rate').value || 50;
    state.settings.maint = +document.getElementById('maint').value || 5;
    save(); calc(); alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª");
}

function resetDay(){ if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…ØŸ")){ state.entries=[]; save(); calc(); } }

function exportExcel(){ 
    let ws = XLSX.utils.json_to_sheet(state.entries);
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Report");
    XLSX.writeFile(wb, "Delivery_Report.xlsx");
}

document.getElementById('rate').value = state.settings.rate;
document.getElementById('maint').value = state.settings.maint;
applyTheme();
calc();
</script>
</body>
</html>
ument.getElementById('rate').value = state.settings.rate;
document.getElementById('maint').value = state.settings.maint;
applyTheme();
calc();
</script>
</body>
</html>
